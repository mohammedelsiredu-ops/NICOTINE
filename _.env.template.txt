# ğŸ”” NICOTINE Clinic v3.1 - Real-Time Events Reference

## Socket.io Integration Guide

### Server Configuration
```javascript
const io = socketIO(server, {
  cors: { 
    origin: process.env.CORS_ORIGIN || "*", 
    methods: ["GET", "POST", "PUT", "DELETE"] 
  },
  transports: ['websocket', 'polling']
});
```

---

## ğŸ“¡ Client Connection

### Basic Setup
```html
<script src="/socket.io/socket.io.js"></script>
<script>
  const socket = io();
  
  socket.on('connect', () => {
    console.log('Connected to server:', socket.id);
  });
  
  socket.on('disconnect', () => {
    console.log('Disconnected from server');
  });
</script>
```

---

## ğŸ¯ Real-Time Events Emitted by Server

### User Management
```javascript
// New user created
socket.on('user_created', (data) => {
  console.log('New user:', data);
  // data: { id: 5 }
  refreshUsersList();
});

// User updated
socket.on('user_updated', (data) => {
  console.log('User updated:', data);
  // data: { id: 3 }
  updateUserInList(data.id);
});

// User deleted
socket.on('user_deleted', (data) => {
  console.log('User deleted:', data);
  // data: { id: 7 }
  removeUserFromList(data.id);
});
```

### Patient Management
```javascript
// New patient registered
socket.on('patient_created', (data) => {
  console.log('New patient:', data);
  // data: { id: 42, name: 'Ù…Ø­Ù…Ø¯ Ø£Ø­Ù…Ø¯' }
  refreshPatientsList();
  showNotification('Ù…Ø±ÙŠØ¶ Ø¬Ø¯ÙŠØ¯: ' + data.name);
});

// Patient updated
socket.on('patient_updated', (data) => {
  console.log('Patient updated:', data);
  // data: { id: 42 }
  updatePatientInList(data.id);
});

// Patient deleted
socket.on('patient_deleted', (data) => {
  console.log('Patient deleted:', data);
  // data: { id: 42 }
  removePatientFromList(data.id);
});
```

### Appointments
```javascript
// New appointment scheduled
socket.on('appointment_created', (data) => {
  console.log('New appointment:', data);
  // data: { id: 15, patient_id: 42 }
  refreshAppointmentsList();
});

// Appointment status changed
socket.on('appointment_updated', (data) => {
  console.log('Appointment updated:', data);
  // data: { id: 15, status: 'completed' }
  updateAppointmentStatus(data.id, data.status);
});

// Appointment cancelled
socket.on('appointment_deleted', (data) => {
  console.log('Appointment deleted:', data);
  // data: { id: 15 }
  removeAppointmentFromList(data.id);
});
```

### Payments
```javascript
// Payment received
socket.on('payment_created', (data) => {
  console.log('Payment received:', data);
  // data: { id: 123, patient_id: 42, amount: 500 }
  refreshPaymentsList();
  updateTotalRevenue(data.amount);
  showNotification('Ø¯ÙØ¹Ø© Ø¬Ø¯ÙŠØ¯Ø©: ' + data.amount + ' Ø¬Ù†ÙŠÙ‡');
});
```

### Medical Records
```javascript
// New medical record added
socket.on('medical_record_created', (data) => {
  console.log('New medical record:', data);
  // data: { id: 88, patient_id: 42 }
  refreshMedicalRecords(data.patient_id);
});
```

### Laboratory
```javascript
// New lab test ordered
socket.on('lab_test_created', (data) => {
  console.log('New lab test:', data);
  // data: { id: 56, patient_id: 42, status: 'pending' }
  
  // Update lab queue
  if (currentUserRole === 'lab') {
    addToLabQueue(data);
    playNotificationSound();
    showNotification('Ø·Ù„Ø¨ ÙØ­Øµ Ø¬Ø¯ÙŠØ¯');
  }
});

// Lab results ready
socket.on('lab_test_updated', (data) => {
  console.log('Lab test updated:', data);
  // data: { id: 56, status: 'completed' }
  
  // Notify doctor
  if (currentUserRole === 'doctor') {
    showNotification('Ù†ØªÙŠØ¬Ø© Ø§Ù„ÙØ­Øµ Ø¬Ø§Ù‡Ø²Ø©');
    updateTestStatus(data.id, data.status);
  }
});
```

### Pharmacy
```javascript
// New prescription created
socket.on('prescription_created', (data) => {
  console.log('New prescription:', data);
  // data: { id: 99, patient_id: 42, medicine_name: 'Ø£Ø³Ø¨Ø±ÙŠÙ†' }
  
  // Update pharmacy queue
  if (currentUserRole === 'pharmacy') {
    addToPharmacyQueue(data);
    showNotification('ÙˆØµÙØ© Ø¬Ø¯ÙŠØ¯Ø©: ' + data.medicine_name);
  }
});

// Medicine dispensed
socket.on('prescription_dispensed', (data) => {
  console.log('Medicine dispensed:', data);
  // data: { id: 99 }
  
  removePrescriptionFromQueue(data.id);
  updateInventory();
});
```

### Inventory
```javascript
// New medicine added
socket.on('inventory_added', (data) => {
  console.log('New medicine:', data);
  // data: { id: 77, medicine_name: 'Ø¨Ø§Ø±Ø§Ø³ÙŠØªØ§Ù…ÙˆÙ„' }
  refreshInventory();
});

// Stock updated
socket.on('inventory_updated', (data) => {
  console.log('Stock updated:', data);
  // data: { id: 77 }
  updateInventoryItem(data.id);
});

// Medicine removed
socket.on('inventory_deleted', (data) => {
  console.log('Medicine deleted:', data);
  // data: { id: 77 }
  removeFromInventory(data.id);
});
```

### Nursing
```javascript
// New nursing order
socket.on('nursing_order_created', (data) => {
  console.log('New nursing order:', data);
  // data: { id: 33, patient_id: 42, status: 'pending' }
  
  // Update nursing queue
  if (currentUserRole === 'nurse') {
    addToNursingQueue(data);
    showNotification('Ø£Ù…Ø± ØªÙ…Ø±ÙŠØ¶ Ø¬Ø¯ÙŠØ¯');
  }
});

// Nursing order completed
socket.on('nursing_order_updated', (data) => {
  console.log('Nursing order updated:', data);
  // data: { id: 33, status: 'completed' }
  
  updateNursingOrderStatus(data.id, data.status);
});
```

### Ultrasound/Radiology
```javascript
// New ultrasound order
socket.on('ultrasound_order_created', (data) => {
  console.log('New ultrasound order:', data);
  // data: { id: 22, patient_id: 42, status: 'pending' }
  
  // Update radiology queue
  if (currentUserRole === 'ultrasound') {
    addToRadiologyQueue(data);
    showNotification('Ø·Ù„Ø¨ Ù…ÙˆØ¬Ø§Øª Ø¬Ø¯ÙŠØ¯');
  }
});

// Results ready
socket.on('ultrasound_order_updated', (data) => {
  console.log('Ultrasound results:', data);
  // data: { id: 22, status: 'completed' }
  
  updateUltrasoundStatus(data.id, data.status);
});

// Image uploaded
socket.on('ultrasound_image_uploaded', (data) => {
  console.log('Image uploaded:', data);
  // data: { id: 22, filename: '1234567890-image.jpg' }
  
  addImageToGallery(data.id, data.filename);
});
```

### Admin Notes
```javascript
// New admin note
socket.on('admin_note_added', (data) => {
  console.log('New admin note:', data);
  // data: { id: 11, priority: 'high' }
  
  // Show notification to admin
  if (currentUserRole === 'admin') {
    showAdminNotification(data);
    if (data.priority === 'high') {
      playUrgentSound();
    }
  }
});
```

### Activity Logging
```javascript
// User activity logged
socket.on('activity_logged', (data) => {
  console.log('Activity:', data);
  // data: { userId: 3, action: 'Ø¥Ø¶Ø§ÙØ© Ù…Ø±ÙŠØ¶', details: 'Name: Ù…Ø­Ù…Ø¯', timestamp: Date }
  
  // Update activity feed
  if (currentUserRole === 'admin') {
    addToActivityFeed(data);
  }
});
```

### User Presence
```javascript
// User connected
socket.on('user_connected', (data) => {
  console.log('User connected:', data);
  // data: { socketId: 'abc123', timestamp: Date }
  incrementOnlineCount();
});

// User disconnected
socket.on('user_disconnected', (data) => {
  console.log('User disconnected:', data);
  // data: { socketId: 'abc123', timestamp: Date }
  decrementOnlineCount();
});

// User typing (collaboration)
socket.on('user_typing', (data) => {
  console.log('User typing:', data);
  showTypingIndicator(data);
});

// User stopped typing
socket.on('user_stop_typing', (data) => {
  console.log('User stopped typing:', data);
  hideTypingIndicator(data);
});
```

---

## ğŸ“¤ Client-to-Server Events

### Typing Indicators
```javascript
// Notify others that user is typing
socket.emit('typing', {
  userId: currentUserId,
  userName: currentUserName,
  location: 'prescription-form'
});

// Notify others that user stopped typing
socket.emit('stop_typing', {
  userId: currentUserId,
  location: 'prescription-form'
});
```

---

## ğŸ¨ UI Integration Examples

### 1. Real-Time Lab Queue (Lab Technician View)
```javascript
// Initialize
const labQueue = [];

// Listen for new tests
socket.on('lab_test_created', (data) => {
  // Fetch test details
  fetch(`/api/lab-tests/${data.id}`)
    .then(res => res.json())
    .then(test => {
      labQueue.push(test);
      renderLabQueue();
      playNotificationSound();
      showToast('Ø·Ù„Ø¨ ÙØ­Øµ Ø¬Ø¯ÙŠØ¯: ' + test.patient_name);
    });
});

// Listen for completed tests
socket.on('lab_test_updated', (data) => {
  if (data.status === 'completed') {
    labQueue = labQueue.filter(t => t.id !== data.id);
    renderLabQueue();
  }
});

function renderLabQueue() {
  const queueHTML = labQueue.map(test => `
    <div class="lab-test-card">
      <h4>${test.patient_name}</h4>
      <p>Tests: ${test.test_names}</p>
      <button onclick="processTest(${test.id})">Process</button>
    </div>
  `).join('');
  
  document.getElementById('lab-queue').innerHTML = queueHTML;
  document.getElementById('queue-count').textContent = labQueue.length;
}
```

### 2. Real-Time Pharmacy Queue
```javascript
// Initialize
const pharmacyQueue = [];

// Listen for new prescriptions
socket.on('prescription_created', (data) => {
  fetch(`/api/prescriptions/${data.id}`)
    .then(res => res.json())
    .then(prescription => {
      pharmacyQueue.push(prescription);
      renderPharmacyQueue();
      showNotification(`ÙˆØµÙØ© Ø¬Ø¯ÙŠØ¯Ø©: ${data.medicine_name}`);
    });
});

// Listen for dispensed medicines
socket.on('prescription_dispensed', (data) => {
  pharmacyQueue = pharmacyQueue.filter(p => p.id !== data.id);
  renderPharmacyQueue();
});

function renderPharmacyQueue() {
  const queueHTML = pharmacyQueue.map(rx => `
    <div class="prescription-card">
      <h4>${rx.patient_name}</h4>
      <p>Medicine: ${rx.medicine_name}</p>
      <p>Dosage: ${rx.dosage}</p>
      <button onclick="dispense(${rx.id})">Dispense</button>
    </div>
  `).join('');
  
  document.getElementById('pharmacy-queue').innerHTML = queueHTML;
}
```

### 3. Real-Time Dashboard Updates
```javascript
// Initialize dashboard data
let stats = {
  totalPatients: 0,
  pendingTests: 0,
  activePrescriptions: 0,
  totalRevenue: 0
};

// Update on patient creation
socket.on('patient_created', () => {
  stats.totalPatients++;
  updateDashboard();
});

// Update on test creation
socket.on('lab_test_created', () => {
  stats.pendingTests++;
  updateDashboard();
});

// Update on test completion
socket.on('lab_test_updated', (data) => {
  if (data.status === 'completed') {
    stats.pendingTests--;
    updateDashboard();
  }
});

// Update on payment
socket.on('payment_created', (data) => {
  stats.totalRevenue += data.amount;
  updateDashboard();
  animateRevenueCounter(data.amount);
});

function updateDashboard() {
  document.getElementById('total-patients').textContent = stats.totalPatients;
  document.getElementById('pending-tests').textContent = stats.pendingTests;
  document.getElementById('total-revenue').textContent = stats.totalRevenue + ' SDG';
}
```

### 4. Real-Time Activity Feed
```javascript
// Activity feed
const activityFeed = [];

// Listen for all activities
socket.on('activity_logged', (data) => {
  activityFeed.unshift(data); // Add to beginning
  
  if (activityFeed.length > 50) {
    activityFeed.pop(); // Keep only last 50
  }
  
  renderActivityFeed();
});

function renderActivityFeed() {
  const feedHTML = activityFeed.map(activity => `
    <div class="activity-item">
      <span class="time">${formatTime(activity.timestamp)}</span>
      <span class="action">${activity.action}</span>
      <span class="details">${activity.details}</span>
    </div>
  `).join('');
  
  document.getElementById('activity-feed').innerHTML = feedHTML;
}
```

### 5. Notification System
```javascript
// Notification helper
function showNotification(message, type = 'info') {
  const notification = document.createElement('div');
  notification.className = `notification notification-${type}`;
  notification.textContent = message;
  
  document.getElementById('notifications').appendChild(notification);
  
  setTimeout(() => {
    notification.classList.add('fade-out');
    setTimeout(() => notification.remove(), 300);
  }, 3000);
}

// Sound helper
function playNotificationSound() {
  const audio = new Audio('/sounds/notification.mp3');
  audio.play().catch(e => console.log('Audio play failed:', e));
}

// Usage with Socket.io
socket.on('lab_test_created', (data) => {
  if (currentUserRole === 'lab') {
    showNotification('Ø·Ù„Ø¨ ÙØ­Øµ Ø¬Ø¯ÙŠØ¯', 'success');
    playNotificationSound();
  }
});
```

---

## ğŸ¯ Best Practices

### 1. Connection Management
```javascript
let socket;
let reconnectAttempts = 0;
const MAX_RECONNECT_ATTEMPTS = 5;

function connectSocket() {
  socket = io({
    reconnection: true,
    reconnectionDelay: 1000,
    reconnectionDelayMax: 5000,
    reconnectionAttempts: MAX_RECONNECT_ATTEMPTS
  });
  
  socket.on('connect', () => {
    console.log('âœ… Connected to server');
    reconnectAttempts = 0;
  });
  
  socket.on('disconnect', () => {
    console.log('âŒ Disconnected from server');
  });
  
  socket.on('reconnect', (attemptNumber) => {
    console.log('ğŸ”„ Reconnected after', attemptNumber, 'attempts');
  });
  
  socket.on('reconnect_failed', () => {
    console.log('âŒ Reconnection failed');
    showNotification('Connection lost. Please refresh.', 'error');
  });
}
```

### 2. Event Cleanup
```javascript
// When changing pages or components
function cleanup() {
  socket.off('lab_test_created');
  socket.off('prescription_created');
  // ... remove all listeners
}

// React/Vue example
onUnmounted(() => {
  cleanup();
});
```

### 3. Role-Based Listening
```javascript
function setupSocketListeners(userRole) {
  // Common events for all roles
  socket.on('patient_created', handlePatientCreated);
  socket.on('appointment_created', handleAppointmentCreated);
  
  // Role-specific events
  if (userRole === 'lab') {
    socket.on('lab_test_created', handleNewLabTest);
    socket.on('lab_test_updated', handleLabTestUpdate);
  }
  
  if (userRole === 'pharmacy') {
    socket.on('prescription_created', handleNewPrescription);
    socket.on('inventory_updated', handleInventoryUpdate);
  }
  
  if (userRole === 'admin') {
    socket.on('activity_logged', handleActivity);
    socket.on('admin_note_added', handleAdminNote);
  }
}
```

### 4. Debouncing Typing Events
```javascript
let typingTimer;
const TYPING_DELAY = 500; // ms

function onInputChange() {
  clearTimeout(typingTimer);
  
  socket.emit('typing', {
    userId: currentUserId,
    userName: currentUserName
  });
  
  typingTimer = setTimeout(() => {
    socket.emit('stop_typing', {
      userId: currentUserId
    });
  }, TYPING_DELAY);
}
```

---

## ğŸ” Debugging

### Enable Debug Mode
```html
<script>
  localStorage.debug = 'socket.io-client:*';
  const socket = io();
</script>
```

### Log All Events
```javascript
socket.onAny((eventName, ...args) => {
  console.log(`ğŸ“¡ Event: ${eventName}`, args);
});
```

### Connection Status
```javascript
console.log('Connected:', socket.connected);
console.log('ID:', socket.id);
```

---

## ğŸ“Š Event Summary

| Event | Triggered When | Emitted To | Data Structure |
|-------|---------------|------------|----------------|
| `user_created` | New user added | All clients | `{ id }` |
| `patient_created` | Patient registered | All clients | `{ id, name }` |
| `lab_test_created` | Test ordered | All clients | `{ id, patient_id, status }` |
| `lab_test_updated` | Results ready | All clients | `{ id, status }` |
| `prescription_created` | Prescription written | All clients | `{ id, patient_id, medicine_name }` |
| `prescription_dispensed` | Medicine given | All clients | `{ id }` |
| `payment_created` | Payment received | All clients | `{ id, patient_id, amount }` |
| `inventory_added` | New medicine | All clients | `{ id, medicine_name }` |
| `nursing_order_created` | Nursing order | All clients | `{ id, patient_id, status }` |
| `ultrasound_order_created` | Ultrasound order | All clients | `{ id, patient_id, status }` |
| `activity_logged` | Any user action | All clients | `{ userId, action, details, timestamp }` |
| `admin_note_added` | Admin note sent | All clients | `{ id, priority }` |

---

**Total Real-Time Events:** 20+  
**Coverage:** All clinical departments  
**Latency:** < 100ms  
**Reliability:** Auto-reconnect enabled  

---

**NICOTINE Clinic v3.1** - Real-Time Collaboration for Modern Healthcare ğŸ¥
